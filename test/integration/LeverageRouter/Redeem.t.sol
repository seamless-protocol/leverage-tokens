// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.26;

// Dependency imports
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";

// Internal imports
import {ILeverageRouter} from "src/interfaces/periphery/ILeverageRouter.sol";
import {IUniswapV2Router02} from "src/interfaces/periphery/IUniswapV2Router02.sol";
import {ActionData} from "src/types/DataTypes.sol";
import {LeverageRouterTest} from "./LeverageRouter.t.sol";

contract LeverageRouterRedeemTest is LeverageRouterTest {
    function testFork_redeem_FullRedeem() public {
        uint256 shares = _deposit();

        address[] memory path = new address[](2);
        path[0] = address(WETH);
        path[1] = address(USDC);

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);
        uint256 collateralForSwap = previewData.collateral * 1.005e18 / 2e18;

        // Approve UniswapV2 to spend the WETH for the swap
        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, UNISWAP_V2_ROUTER02, collateralForSwap),
            value: 0
        });
        // Swap WETH to USDC
        calls[1] = ILeverageRouter.Call({
            target: UNISWAP_V2_ROUTER02,
            data: abi.encodeWithSelector(
                IUniswapV2Router02.swapExactTokensForTokens.selector,
                collateralForSwap,
                0,
                path,
                address(leverageRouter),
                block.timestamp
            ),
            value: 0
        });

        // On chain exact input swap of collateralForSwap using UniswapV2 results in ~6 USDC being left over
        uint256 expectedSurplusDebt = 6.245106e6;

        _redeemAndAssertBalances(shares, 0, calls, expectedSurplusDebt);
    }

    function testFork_redeem_PartialRedeem() public {
        uint256 shares = _deposit();
        uint256 sharesToRedeem = shares / 2;

        address[] memory path = new address[](2);
        path[0] = address(WETH);
        path[1] = address(USDC);

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, sharesToRedeem);
        uint256 collateralForSwap = previewData.collateral * 1.005e18 / 2e18;

        // Approve UniswapV2 to spend the WETH for the swap
        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, UNISWAP_V2_ROUTER02, collateralForSwap),
            value: 0
        });
        // Swap WETH to USDC
        calls[1] = ILeverageRouter.Call({
            target: UNISWAP_V2_ROUTER02,
            data: abi.encodeWithSelector(
                IUniswapV2Router02.swapExactTokensForTokens.selector,
                collateralForSwap,
                0,
                path,
                address(leverageRouter),
                block.timestamp
            ),
            value: 0
        });

        // On chain exact input swap of collateralForSwap using UniswapV2 results in ~3.5 USDC being left over
        uint256 expectedSurplusDebt = 3.538999e6;

        _redeemAndAssertBalances(sharesToRedeem, 0, calls, expectedSurplusDebt);
    }

    function testFork_redeem_LiFiExactInputSwap() public {
        vm.rollFork(35069151);
        _deployLeverageRouterIntegrationTestContracts();

        uint256 shares = _deposit();

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);
        uint256 collateralForSwap = previewData.collateral * 1.004e18 / 2e18;
        assertEq(collateralForSwap, 0.880479727606528588 ether);

        // Generated with:
        // curl --request GET --url 'https://li.quest/v1/quote?fromChain=8453&toChain=8453&toToken=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&fromToken=0x4200000000000000000000000000000000000006&fromAddress=0x756e0562323ADcDA4430d6cb456d9151f605290B&fromAmount=880479727606528588&slippage=0.01&allowBridges=none'
        bytes memory sellCalldata =
            hex"5fd9ae2e3d7bac6a4eee4abf5704646f0ef3c1c510c17d8a72bcd3f780b64a52452f787e00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000756e0562323adcda4430d6cb456d9151f605290b00000000000000000000000000000000000000000000000000000000e7c26d16000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000086c6966692d617069000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff0000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff000000000000000000000000420000000000000000000000000000000000000600000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000c3817a5b3eb7a4c00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007d1faa77d6381000000000000000000000000b9c0de368bece5e76b52545a8e377a4c118f597b00000000000000000000000000000000000000000000000000000000000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b750000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000c3045ab0c6e16cb00000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a45f3bd1c800000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000c3045ab0c6e16cb0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000e7c26d150000000000000000000000002905d7e4d048d29954f81b02171dd313f457a4a400000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001846be92b8900000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000c3045ab0c6e16cb000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000ea19b92d0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004301420000000000000000000000000000000000000601ffff01b2cc224c1c9fee385f8ad6a55b4d94e92359dc59012905d7e4d048d29954f81b02171dd313f457a4a40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, LIFI_DIAMOND, collateralForSwap),
            value: 0
        });
        calls[1] = ILeverageRouter.Call({target: LIFI_DIAMOND, data: sellCalldata, value: 0});

        // ~537 USDC left over from the swap
        _redeemAndAssertBalances(shares, previewData.collateral - collateralForSwap, calls, 537.37438e6);
    }

    function testFork_redeem_LiFiExactOutputSwap() public {
        vm.rollFork(35069889);
        _deployLeverageRouterIntegrationTestContracts();

        uint256 shares = _deposit();

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);
        assertEq(previewData.collateral, 1.753340064024658678 ether);
        assertEq(previewData.debt, 3920.242795e6);

        bytes memory buyCalldata =
            hex"5fd9ae2efa65e875c027a6aee2d5d4d0867f80bf9976ae165a5c379a2a046f5564b9a63c00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000756e0562323adcda4430d6cb456d9151f605290b00000000000000000000000000000000000000000000000000000000e9c528b3000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000086c6966692d617069000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff0000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff000000000000000000000000420000000000000000000000000000000000000600000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000d896d03f54b899b00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008a9df5eb17806000000000000000000000000b9c0de368bece5e76b52545a8e377a4c118f597b000000000000000000000000000000000000000000000000000000000000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000d80c324969a119500000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ac4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005c0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004ef010100000444000000d547727b926648af3f31dbb89e3b93e49f78dcb800000000000000000d80c324969a1195000003e40947c2d9000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b909713394cf63f9771b1f7101590f729c27cec600000000000000000000000026a5652812905cc994009902c4b4dff950f967750000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000d80c324969a11950000000000000000000000000000000000000000000000000000000103cd87f700000000000000000000000000000000000000000000000000000000e9d293f70000000000000000000000000000000000000000000000000000000068b89e8e00000000000000000000000000000000000000000000000000d0286be5e38e390000000000000000000000000000000000000000000000000000000068b89e5700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002058934fcf5a8e437898a56a41a299671c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002800000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000041c3a22d87e2848b93bac6918e6b0aa06b27ef7ff5a68c0782337fafd76ba282274f763ab9ea7305f3e4a8b0806ad96d8fc6e2e03fb41058643c318b706b856a841c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041793e233d22c17dd5d61bbce10ddca911e9ea63dfe7a2084a17d5f106ad35a300221c49ffceccebd4f096c01a1e2f84398b3ecaccdcbe1b18779f23d1b3cd8d3b1b00000000000000000000000000000000000000000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130200000000000000000000000000000000000000000000002400000000000000442c4200000000000000000000000000000000000006833589fcd6edb6e08f4c7c32d4f71b54bda029131231deb6f5749ef6ce6943a275a1d3e7486f4eae00000000000000000000000068b8a3020000005400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110500000000000000000000000103be9f004f82e73edb06d29ff62c91ec8f5ff06571bdeb2900000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000000000000000000000000000000d80c324969a119500000000000000000000000000000000000000000000000000000000e9c528b20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000d80c324969a1195000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027a7b22536f75726365223a226c692e6669222c22416d6f756e74496e555344223a22343335362e313937333336383530393934222c22416d6f756e744f7574555344223a22343335382e383430323232303932363436222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2234333537373931343837222c2254696d657374616d70223a313735363932393631392c22526f7574654944223a2230653233333537632d613534662d343832362d613066392d3564666165643839313933663a61336230396336372d303038302d346135312d623062652d333963373031663139366561222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22446e656c6c68642b7243675a65303354327543704942507a6835732f3834416463546a6661512b33586a61483444483768444a5145626f7243736e4d48624d5736657236347667385235345678413147447a2f4a2f7147584259757246527258795047306f776c6c484c524e46575a4f4474742b46356f6a4147313979475a4d4170586967544e5762734d3462372b66482b7359367a6e73742f66474c4d4b4361686351674d357a61503561593369364a5834714f66797571704731416478536553393754444e77474e545a436d35656b326a5a63436242464637546f504e45775a582f42595851557644634a2b2f79736c394a74444b76376e547a666e76447055316c35546d70744e635742776c465232617931316e50446248434b592b516161464b396f73784d355456516c323858733767533076424c3046383148335352396b723258434369615177646d35496130482f30513d3d227d7d00000000000000000000000000000000000000000000000000000000000000000000";

        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, LIFI_DIAMOND, previewData.collateral),
            value: 0
        });
        calls[1] = ILeverageRouter.Call({target: LIFI_DIAMOND, data: buyCalldata, value: 0});

        uint256 equityInCollateral = previewData.collateral / 2;
        uint256 remainingCollateralForSenderAfterSwap = 0.777909405954537819 ether;
        uint256 slippage = 1e18 - (remainingCollateralForSenderAfterSwap * 1e18 / equityInCollateral);
        assertEq(slippage, 0.112654274072873256e18); // An additional ~11% of the user's equity was required for the swap

        // ~975 USDC left over from the swap
        _redeemAndAssertBalances(shares, 0.777909405954537819 ether, calls, 975.198955e6);
    }

    function _deposit() internal returns (uint256 shares) {
        uint256 collateralFromSender = 1 ether;
        uint256 userBalanceOfCollateralAsset = 4 ether;
        uint256 flashLoanAmount = 3382.592531e6;

        address[] memory path = new address[](2);
        path[0] = address(USDC);
        path[1] = address(WETH);

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);
        // Approve UniswapV2 to spend the USDC for the swap
        calls[0] = ILeverageRouter.Call({
            target: address(USDC),
            data: abi.encodeWithSelector(IERC20.approve.selector, UNISWAP_V2_ROUTER02, flashLoanAmount),
            value: 0
        });
        // Swap USDC to WETH
        calls[1] = ILeverageRouter.Call({
            target: UNISWAP_V2_ROUTER02,
            data: abi.encodeWithSelector(
                IUniswapV2Router02.swapExactTokensForTokens.selector,
                flashLoanAmount,
                0,
                path,
                address(leverageRouter),
                block.timestamp
            ),
            value: 0
        });

        uint256 sharesBefore = leverageToken.balanceOf(user);

        _dealAndDeposit(WETH, USDC, userBalanceOfCollateralAsset, collateralFromSender, flashLoanAmount, 0, calls);

        uint256 sharesAfter = leverageToken.balanceOf(user) - sharesBefore;

        return sharesAfter;
    }

    function _redeemAndAssertBalances(
        uint256 shares,
        uint256 minCollateralForSender,
        ILeverageRouter.Call[] memory swapCalls,
        uint256 expectedDebtForSender
    ) internal {
        uint256 collateralBeforeRedeem = morphoLendingAdapter.getCollateral();
        uint256 debtBeforeRedeem = morphoLendingAdapter.getDebt();
        uint256 userBalanceOfCollateralAssetBeforeRedeem = WETH.balanceOf(user);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);

        vm.startPrank(user);
        leverageToken.approve(address(leverageRouter), shares);
        leverageRouter.redeem(leverageToken, shares, minCollateralForSender, swapCalls);
        vm.stopPrank();

        // Check that the periphery contracts don't hold any assets
        assertEq(WETH.balanceOf(address(leverageRouter)), 0);
        assertEq(USDC.balanceOf(address(leverageRouter)), 0);

        // Collateral and debt are removed from the leverage token
        assertEq(morphoLendingAdapter.getCollateral(), collateralBeforeRedeem - previewData.collateral);
        assertEq(morphoLendingAdapter.getDebt(), debtBeforeRedeem - previewData.debt);

        // The user receives back at least the min collateral
        assertGe(WETH.balanceOf(user), userBalanceOfCollateralAssetBeforeRedeem + minCollateralForSender);

        // Validate that user also received the expected debt surplus from the swap
        assertEq(USDC.balanceOf(user), expectedDebtForSender);
    }
}
