// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.26;

// Dependency imports
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";

// Internal imports
import {ILeverageRouter} from "src/interfaces/periphery/ILeverageRouter.sol";
import {IUniswapV2Router02} from "src/interfaces/periphery/IUniswapV2Router02.sol";
import {ActionData} from "src/types/DataTypes.sol";
import {LeverageRouterTest} from "./LeverageRouter.t.sol";

contract LeverageRouterRedeemTest is LeverageRouterTest {
    function testFork_redeem_FullRedeem() public {
        uint256 shares = _deposit();

        address[] memory path = new address[](2);
        path[0] = address(WETH);
        path[1] = address(USDC);

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);
        uint256 collateralForSwap = previewData.collateral * 1.005e18 / 2e18;

        // Approve UniswapV2 to spend the WETH for the swap
        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, UNISWAP_V2_ROUTER02, collateralForSwap),
            value: 0
        });
        // Swap WETH to USDC
        calls[1] = ILeverageRouter.Call({
            target: UNISWAP_V2_ROUTER02,
            data: abi.encodeWithSelector(
                IUniswapV2Router02.swapExactTokensForTokens.selector,
                collateralForSwap,
                0,
                path,
                address(leverageRouter),
                block.timestamp
            ),
            value: 0
        });

        // On chain exact input swap of collateralForSwap using UniswapV2 results in ~6 USDC being left over
        uint256 expectedSurplusDebt = 6.245106e6;

        _redeemAndAssertBalances(shares, 0, calls, expectedSurplusDebt);
    }

    function testFork_redeem_PartialRedeem() public {
        uint256 shares = _deposit();
        uint256 sharesToRedeem = shares / 2;

        address[] memory path = new address[](2);
        path[0] = address(WETH);
        path[1] = address(USDC);

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, sharesToRedeem);
        uint256 collateralForSwap = previewData.collateral * 1.005e18 / 2e18;

        // Approve UniswapV2 to spend the WETH for the swap
        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, UNISWAP_V2_ROUTER02, collateralForSwap),
            value: 0
        });
        // Swap WETH to USDC
        calls[1] = ILeverageRouter.Call({
            target: UNISWAP_V2_ROUTER02,
            data: abi.encodeWithSelector(
                IUniswapV2Router02.swapExactTokensForTokens.selector,
                collateralForSwap,
                0,
                path,
                address(leverageRouter),
                block.timestamp
            ),
            value: 0
        });

        // On chain exact input swap of collateralForSwap using UniswapV2 results in ~3.5 USDC being left over
        uint256 expectedSurplusDebt = 3.538999e6;

        _redeemAndAssertBalances(sharesToRedeem, 0, calls, expectedSurplusDebt);
    }

    function testFork_redeem_LiFiExactInputSwap() public {
        vm.rollFork(35069151);
        _deployLeverageRouterIntegrationTestContracts();

        uint256 shares = _deposit();

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);
        uint256 collateralForSwap = previewData.collateral * 1.004e18 / 2e18;
        assertEq(collateralForSwap, 0.880479727606528588 ether);

        // Generated with:
        // curl --request GET --url 'https://li.quest/v1/quote?fromChain=8453&toChain=8453&toToken=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&fromToken=0x4200000000000000000000000000000000000006&fromAddress=0x756e0562323ADcDA4430d6cb456d9151f605290B&fromAmount=880479727606528588&slippage=0.01&allowBridges=none'
        bytes memory sellCalldata =
            hex"5fd9ae2e3d7bac6a4eee4abf5704646f0ef3c1c510c17d8a72bcd3f780b64a52452f787e00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000756e0562323adcda4430d6cb456d9151f605290b00000000000000000000000000000000000000000000000000000000e7c26d16000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000086c6966692d617069000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff0000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff000000000000000000000000420000000000000000000000000000000000000600000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000c3817a5b3eb7a4c00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007d1faa77d6381000000000000000000000000b9c0de368bece5e76b52545a8e377a4c118f597b00000000000000000000000000000000000000000000000000000000000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b750000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000c3045ab0c6e16cb00000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a45f3bd1c800000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000c3045ab0c6e16cb0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000e7c26d150000000000000000000000002905d7e4d048d29954f81b02171dd313f457a4a400000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001846be92b8900000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000c3045ab0c6e16cb000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000ea19b92d0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004301420000000000000000000000000000000000000601ffff01b2cc224c1c9fee385f8ad6a55b4d94e92359dc59012905d7e4d048d29954f81b02171dd313f457a4a40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, LIFI_DIAMOND, collateralForSwap),
            value: 0
        });
        calls[1] = ILeverageRouter.Call({target: LIFI_DIAMOND, data: sellCalldata, value: 0});

        // ~537 USDC left over from the swap
        _redeemAndAssertBalances(shares, previewData.collateral - collateralForSwap, calls, 537.37438e6);
    }

    function testFork_redeem_LiFiExactOutputSwap() public {
        vm.rollFork(35069889);
        _deployLeverageRouterIntegrationTestContracts();

        uint256 shares = _deposit();

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);
        assertEq(previewData.collateral, 1.753340064024658678 ether);
        assertEq(previewData.debt, 3920.242795e6);

        // Generated with:
        //curl --request GET --url 'https://li.quest/v1/quote/toAmount?fromChain=8453&toChain=8453&fromToken=0x4200000000000000000000000000000000000006&toToken=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913&fromAddress=0x756e0562323ADcDA4430d6cb456d9151f605290B&toAmount=3920242795&slippage=0.01&allowBridges=none'
        bytes memory buyCalldata =
            hex"5fd9ae2efa1bd3f281e5687a029347e3ab3f27d681651f207054500cda35f4eab80f45b300000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000756e0562323adcda4430d6cb456d9151f605290b00000000000000000000000000000000000000000000000000000000e9aaec30000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000086c6966692d617069000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff0000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff000000000000000000000000420000000000000000000000000000000000000600000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000c4b8e4d324b331700000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007de6f8d90d3f7000000000000000000000000b9c0de368bece5e76b52545a8e377a4c118f597b000000000000000000000000000000000000000000000000000000000000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000c43afdda4ba5f2000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b44e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000008800000000000000000000000000000000000000000000000000000000000000575030100000444000000d547727b926648af3f31dbb89e3b93e49f78dcb80000000000000000009cfbfe483c84c1000003e40947c2d9000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b909713394cf63f9771b1f7101590f729c27cec600000000000000000000000026a5652812905cc994009902c4b4dff950f967750000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000009cfbfe483c84c1000000000000000000000000000000000000000000000000000000000bcd76f5000000000000000000000000000000000000000000000000000000000baf40010000000000000000000000000000000000000000000000000000000068b8a0400000000000000000000000000000000000000000000000004120e9746896ab1d0000000000000000000000000000000000000000000000000000000068b8a009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000657f4e72bbe5490d9a0b1b5a76ae5d0700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002800000000000000000000000006044eef7179034319e2c8636ea885b37cbfa9aba0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000417e96e4abb09229f4d2302068fe31df9e3236be69dd709b55c7d385175cfa4e1b1fa1cdcff51dffe825f6c003b489af3139895d9658f9467aab5ab4593f8f58711b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004105ded33524797ed1db7a18741d5ceb5bdb9a54d9d0fb2203efc61d578033151060ab3ea8831f7577df2b1e12bf1006ae3c076a2fd3106298336b822ed1cda6a01b00000000000000000000000000000000000000000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130200000000000000000000000000000000000000000000002400000000000000442c010000003d0200000072ab388e2e2f6facef59e3c3fa2c4e29011c2d3800000000000000000b096780d39947020100000000000000000000000000000001000276a40a010000003d02000000dbc6998296caa1652a810dc8d3baf4a8294330f10000000000000000009d4c5e88e4935d0100000000000000000000000000000001000276a40a4200000000000000000000000000000000000006833589fcd6edb6e08f4c7c32d4f71b54bda029131231deb6f5749ef6ce6943a275a1d3e7486f4eae00000000000000000000000068b8a4b500000054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f77000000000000000000000000ec0727764f82e73edb06d29ff62c91ec8f5ff06571bdeb2900000000000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000000000000000000000000000000c43afdda4ba5f2000000000000000000000000000000000000000000000000000000000e9aaec2e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000c43afdda4ba5f20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027c7b22536f75726365223a226c692e6669222c22416d6f756e74496e555344223a22333935372e32323733383733393931373038222c22416d6f756e744f7574555344223a22333935372e35323037343337363637303435222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2233393539383931383239222c2254696d657374616d70223a313735363933303035332c22526f7574654944223a2235303137353735392d363063362d343134392d616666322d6466306138373035636461373a31303163653237612d356663382d343339612d613336382d643361393436336662313239222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22616b51506b576c2f7163686a692b62617541313473527174336e5478757552776b4d624f375571575131633563665735554c5149514f6447724f4748425a355a7774344c70554a465933395343305974582f485554596d61566f584530695042637a2f647a41695648696e4c7a2f4b5736772b744b484f77564b7347734841522f37755666367a2f722b354c694d466175722b66324e4d554443525a435047726c70636c37475a4d6d506c4e3338646f4b30774d73493647666b544652583872434f6b705446636456487052664e2f387a39726d582f5372586744624d4278586b6e4d755a56786d6d47303253797236584e57574c35413051386b374b705a51616969565142667136374652717859716a47716c2f56634f3535475a6b466363674f2b65654a62442f2b636769746e32794439472b5634794b495178655842744d7644683967653539336f5550756f584333713637773d3d227d7d0000000000000000000000000000000000000000000000000000000000000000";

        calls[0] = ILeverageRouter.Call({
            target: address(WETH),
            data: abi.encodeWithSelector(IERC20.approve.selector, LIFI_DIAMOND, previewData.collateral),
            value: 0
        });
        calls[1] = ILeverageRouter.Call({target: LIFI_DIAMOND, data: buyCalldata, value: 0});

        uint256 equityInCollateral = previewData.collateral / 2; // 2x leverage strategy
        uint256 remainingCollateralForSenderAfterSwap = 0.867381850108809183 ether;
        uint256 slippage = 1e18 - (remainingCollateralForSenderAfterSwap * 1e18 / equityInCollateral);
        assertEq(slippage, 0.010594843629135858e18); // An additional ~1.5% of the user's equity was required for the swap

        // ~572 USDC left over from the swap
        _redeemAndAssertBalances(shares, 0.867381850108809183 ether, calls, 571.580586e6);
    }

    function _deposit() internal returns (uint256 shares) {
        uint256 collateralFromSender = 1 ether;
        uint256 userBalanceOfCollateralAsset = 4 ether;
        uint256 flashLoanAmount = 3382.592531e6;

        address[] memory path = new address[](2);
        path[0] = address(USDC);
        path[1] = address(WETH);

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);
        // Approve UniswapV2 to spend the USDC for the swap
        calls[0] = ILeverageRouter.Call({
            target: address(USDC),
            data: abi.encodeWithSelector(IERC20.approve.selector, UNISWAP_V2_ROUTER02, flashLoanAmount),
            value: 0
        });
        // Swap USDC to WETH
        calls[1] = ILeverageRouter.Call({
            target: UNISWAP_V2_ROUTER02,
            data: abi.encodeWithSelector(
                IUniswapV2Router02.swapExactTokensForTokens.selector,
                flashLoanAmount,
                0,
                path,
                address(leverageRouter),
                block.timestamp
            ),
            value: 0
        });

        uint256 sharesBefore = leverageToken.balanceOf(user);

        _dealAndDeposit(WETH, USDC, userBalanceOfCollateralAsset, collateralFromSender, flashLoanAmount, 0, calls);

        uint256 sharesAfter = leverageToken.balanceOf(user) - sharesBefore;

        return sharesAfter;
    }

    function _redeemAndAssertBalances(
        uint256 shares,
        uint256 minCollateralForSender,
        ILeverageRouter.Call[] memory swapCalls,
        uint256 expectedDebtForSender
    ) internal {
        uint256 collateralBeforeRedeem = morphoLendingAdapter.getCollateral();
        uint256 debtBeforeRedeem = morphoLendingAdapter.getDebt();
        uint256 userBalanceOfCollateralAssetBeforeRedeem = WETH.balanceOf(user);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);

        vm.startPrank(user);
        leverageToken.approve(address(leverageRouter), shares);
        leverageRouter.redeem(leverageToken, shares, minCollateralForSender, swapCalls);
        vm.stopPrank();

        // Check that the periphery contracts don't hold any assets
        assertEq(WETH.balanceOf(address(leverageRouter)), 0);
        assertEq(USDC.balanceOf(address(leverageRouter)), 0);

        // Collateral and debt are removed from the leverage token
        assertEq(morphoLendingAdapter.getCollateral(), collateralBeforeRedeem - previewData.collateral);
        assertEq(morphoLendingAdapter.getDebt(), debtBeforeRedeem - previewData.debt);

        // The user receives back at least the min collateral
        assertGe(WETH.balanceOf(user), userBalanceOfCollateralAssetBeforeRedeem + minCollateralForSender);

        // Validate that user also received the expected debt surplus from the swap
        assertEq(USDC.balanceOf(user), expectedDebtForSender);
    }
}
