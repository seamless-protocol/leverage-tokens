// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.26;

// Dependency imports
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";

// Internal imports
import {ISwapAdapter} from "src/interfaces/periphery/ISwapAdapter.sol";
import {ActionData} from "src/types/DataTypes.sol";
import {LeverageRouterTest} from "./LeverageRouter.t.sol";

contract LeverageRouterDepositTest is LeverageRouterTest {
    function testFork_deposit_Velora() public {
        // Approximate block this test was written. Velora calldata needs to be generated near this block.
        vm.rollFork(23290736);
        _deployLeverageRouterIntegrationTestContracts();

        uint256 collateralFromSender = 0.5e8; // Half of 1 cbBTC
        uint256 collateralToAdd = 2 * collateralFromSender;
        uint256 userBalanceOfCollateralAsset = 2 * collateralToAdd; // User has more than enough assets for the deposit
        uint256 flashLoanAmount = 54736.165347e6;
        uint256 minShares = 0.5e18 * 0.99e18 / 1e18; // 1% slippage

        {
            // Sanity check that LR preview deposit matches test params
            ActionData memory leverageRouterPreview = leverageRouter.previewDeposit(leverageToken, collateralFromSender);
            assertEq(leverageRouterPreview.debt, flashLoanAmount);
            assertEq(leverageRouterPreview.shares, 0.5e18);
            assertEq(leverageRouterPreview.collateral, collateralToAdd);
            assertEq(leverageRouterPreview.tokenFee, 0);
            assertEq(leverageRouterPreview.treasuryFee, 0);
        }

        bytes memory sellCalldata =
            hex"e3ead59e00000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf0000000000000000000000000000000000000000000000000000000cbe8799e30000000000000000000000000000000000000000000000000000000002f29ee60000000000000000000000000000000000000000000000000000000002fa3e3e2cf4d0f73bb2497993463d452d54e4f800000000000000000000000001636311000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001b8000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001b80000000000000000000000000000008a000000000000001c0000000000000106800000000000000000000000000000000000000000000072006c4018f000a000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006c00000000000000000000000000000016000000000000001200000000000000b29e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2eaa200000000000000000000000000000000000000000000000000000001877be6a10000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f42260fac5e5542a773aa44fbcfedf7c193bc2c5990000000000000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000001be7a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af00000000000000000000000000000000000000000000000000000003d2c74aa566a9893cc07d91d95644aedd05d03f95e1dba8af0000048002e40000ff0000030000000000000000000000000000000000000000000000000000000024856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003d2c74aa50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000c600b30fb0400701010f4b080409018b9006e000000000000000000000000000000000000000000000000000000000000000009995855c00494d039ab6792f18e368e530dff9310000014000840000ff00000300000000000000000000000000000000000000000000000000000000f196187f0000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf000000000000000000000000000000000000000000029f16b11c6d1e0000003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001401948000000000000000000000000000000000000000000000000400065a8177fae27000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000126000000000000000a000000000000016a800000000000000000000000000000000000000000000056005040224000a000b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000001e00000000000000000000000000000040aa0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb000000000000000000000000eb1da432d5c1a9fdf52aa5d37698f34706f9139700000000000000000000000000000000000000000000000000000000c3a911fceb1da432d5c1a9fdf52aa5d37698f34706f91397000001400024000020000003000000000000000000000000000000000000000000000000000000003eece7db00000000000000000000000000c600b30fb0400701010f4b080409018b9006e000000000000000000000000000000000000000000000000000000000c3a911fc00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000016000000000000001200000000000001af1e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2eaa2000000000000000000000000000000000000000000000000000000051918c17f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f4c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000016000000000000001200000000000000815e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2eaa200000000000000000000000000000000000000000000000000000001878295220000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000064c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000009e00984018f000a000b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000980000000000000000000000000000001600000000000000120000000000000102ae592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2eaa20000000000000000000000000000000000000000000000002a47e1d16935d77e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002bc02aaa39b223fe8d0a0e5c4f27ead9083c756cc20001f42260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000001435c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af00000000000000000000000000000000000000000000000034db2915ef9ad93e66a9893cc07d91d95644aedd05d03f95e1dba8af0000052003640000ff0000030000000000000000000000000000000000000000000000000000000024856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000020c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000034db2915ef9ad93e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000200000000000000016c00000000000002b1ba12222222228d8ba445958a75a0704d566bf2c8000001e001640000000000030000000000000000000000000000000000000000000000000000000052bbbe2900000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000068c2eaa2a6f548df93de924d73be7d25dc02554c6bd66db500020000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000000000000000000000000000070a3c8d56bee96b00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000e592427a0aece92de3edee1f18e0157c0586156400000140008400ef0000000b00000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2eaa20000000000000000000000000000000000000000000000000000000001b9c2a30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b2260fac5e5542a773aa44fbcfedf7c193bc2c5990001f418084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000000000000000000000ae6ee608b297305abf3eb609b81febbb8f6a0bb3000000e0004400a4ff00000b000000000000000000000000000000000000000000000000000000003df02124000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000407d17ce4f80e95000000000000000000000000000000000000000000000000000000000000000100000000000000000000000018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bfcbb7c0000ab88b473b1f5afd9ef808440eed33bf0000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000000000001ba2556";
        uint256 collateralReceivedFromDebtSwap = 0.49883735e8;

        // The swap results in less collateral than required to get the flash loaned debt amount from a LM deposit, so the debt amount flash loaned
        // needs to be reduced.
        uint256 flashLoanAmountReduced = 54600.165347e6;

        // New calldata for swap of ~54600 USDC
        sellCalldata =
            hex"e3ead59e00000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf0000000000000000000000000000000000000000000000000000000cb66c67e30000000000000000000000000000000000000000000000000000000002eff9ff0000000000000000000000000000000000000000000000000000000002f79281bce7a529eebe44659fdeb6647117805b0000000000000000000000000163639500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000196000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001960000000000000000000000000000008a000000000000001c0000000000000138800000000000000000000000000000000000000000000072006c4018f000a000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006c00000000000000000000000000000016000000000000001200000000000001130e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d600000000000000000000000000000000000000000000000000000002cbf921180000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f42260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000015e0a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af000000000000000000000000000000000000000000000000000000038f3d12d966a9893cc07d91d95644aedd05d03f95e1dba8af0000048002e40000ff0000030000000000000000000000000000000000000000000000000000000024856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f3d12d90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000c600b30fb0400701010f4b080409018b9006e000000000000000000000000000000000000000000000000000000000000000009995855c00494d039ab6792f18e368e530dff9310000014000840000ff00000300000000000000000000000000000000000000000000000000000000f196187f0000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf000000000000000000000000000000000000000000029f16b11c6d1e00000032000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017bc79e000000000000000000000000000000000000000000000000400065a8177fae27000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000104000000000000000a0000000000000138800000000000000000000000000000000000000000000056005040224000a000b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000001e000000000000000000000000000000320a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb000000000000000000000000eb1da432d5c1a9fdf52aa5d37698f34706f9139700000000000000000000000000000000000000000000000000000000822d4bd6eb1da432d5c1a9fdf52aa5d37698f34706f91397000001400024000020000003000000000000000000000000000000000000000000000000000000003eece7db00000000000000000000000000c600b30fb0400701010f4b080409018b9006e000000000000000000000000000000000000000000000000000000000822d4bd600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000160000000000000012000000000000012c0e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d6000000000000000000000000000000000000000000000000000000030d0fc7030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000bb8c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000016000000000000001200000000000001130e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d600000000000000000000000000000000000000000000000000000002cbf921190000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f4c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000007c00764018f000a000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000076000000000000000000000000000000160000000000000012000000000000015e0e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d60000000000000000000000000000000000000000000000003127c207eaaf8db30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002bc02aaa39b223fe8d0a0e5c4f27ead9083c756cc20001f42260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000001130c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af000000000000000000000000000000000000000000000000269f3d0638655d0c66a9893cc07d91d95644aedd05d03f95e1dba8af0000052003640000ff0000030000000000000000000000000000000000000000000000000000000024856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000020c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000269f3d0638655d0c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2e592427a0aece92de3edee1f18e0157c0586156400000140008400ef0000000b00000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d600000000000000000000000000000000000000000000000000000000017b74380000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b2260fac5e5542a773aa44fbcfedf7c193bc2c5990001f418084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000000000000000000000ae6ee608b297305abf3eb609b81febbb8f6a0bb3000000e0004400a4ff00000b000000000000000000000000000000000000000000000000000000003df021240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000003764ec042a9b9f2000000000000000000000000000000000000000000000000000000000000000100000000000000000000000018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bfcbb7c0000ab88b473b1f5afd9ef808440eed33bf0000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb0000000000000000000000006a000f20005980200259b80c510200304000106800000000000000000000000000000000000000000000000000000000017bcb92";
        // Updated collateral received from the debt swap for lower debt amount
        collateralReceivedFromDebtSwap = 0.4976719e8;

        // Preview again using the total collateral. This is used by the LM deposit logic
        uint256 totalCollateral = collateralFromSender + collateralReceivedFromDebtSwap;
        ActionData memory previewData = leverageManager.previewDeposit(leverageToken, totalCollateral);
        assertGe(previewData.debt, flashLoanAmountReduced);
        assertEq(previewData.debt, 54608.73408e6);

        // More than minShares (1% slippage) will be minted
        assertGe(previewData.shares, minShares);
        assertEq(previewData.shares, 0.49883595e18);

        ISwapAdapter.Call[] memory calls = new ISwapAdapter.Call[](2);
        // Approve Velora to spend the USDC for the swap
        calls[0] = ISwapAdapter.Call({
            target: address(USDC),
            data: abi.encodeWithSelector(IERC20.approve.selector, address(AUGUSTUS_V6_2), flashLoanAmountReduced),
            value: 0
        });
        // Swap USDC to CBBTC
        calls[1] = ISwapAdapter.Call({target: AUGUSTUS_V6_2, data: sellCalldata, value: 0});

        _dealAndDeposit(
            CBBTC, USDC, userBalanceOfCollateralAsset, collateralFromSender, flashLoanAmountReduced, minShares, calls
        );

        // Collateral is taken from the user for the deposit. All of the collateral should be used
        assertEq(CBBTC.balanceOf(user), userBalanceOfCollateralAsset - collateralFromSender);

        // Any additional debt that is not used to repay the flash loan is given to the user
        uint256 excessDebt = previewData.debt - flashLoanAmountReduced;
        assertEq(USDC.balanceOf(user), excessDebt);
        assertEq(USDC.balanceOf(user), 8.568733e6);

        assertGe(leverageToken.balanceOf(user), minShares);

        assertEq(morphoLendingAdapter.getCollateral(), totalCollateral);
        assertEq(morphoLendingAdapter.getDebt(), previewData.debt + 1); // + 1 because of rounding up by MorphoBalancesLib.expectedBorrowAssets
    }
}
