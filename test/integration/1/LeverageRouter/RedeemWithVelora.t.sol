// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.26;

// Dependency imports
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";

// Internal imports
import {ILeverageRouter} from "src/interfaces/periphery/ILeverageRouter.sol";
import {IUniswapV2Router02} from "src/interfaces/periphery/IUniswapV2Router02.sol";
import {IVeloraAdapter} from "src/interfaces/periphery/IVeloraAdapter.sol";
import {ActionData} from "src/types/DataTypes.sol";
import {LeverageRouterTest} from "./LeverageRouter.t.sol";

contract LeverageRouterRedeemWithVeloraTest is LeverageRouterTest {
    uint256 outputAmountOffset = 132;
    uint256 maxInputAmountOffset = 100;
    uint256 quotedInputAmountOffset = 164;

    function testFork1_redeemWithVelora_FullRedeem() public {
        uint256 shares = _deposit();

        // Preview the redemption of shares
        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);
        assertEq(previewData.debt, 54614.668577e6);
        assertEq(previewData.collateral, 0.99778033e8);

        bytes memory buyCalldata =
            hex"7f4576750000000000000000000000000e5891850bb3f03090f03010000806f080040100000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000030226350000000000000000000000000000000000000000000000000000000cb749b5210000000000000000000000000000000000000000000000000000000002fa862561b05503c1a84b9fb95ff6e5bc8cee4f000000000000000000000000016364140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000900000006e000000000000000000000030c00000000000000000000000000000960cbb7c0000ab88b473b1f5afd9ef808440eed33bf00600044002400000000000300000000000000000000000000000000000000000000000000000000a9059cbb00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af0000000000000000000000000000000000000000000000000000000000b6d46166a9893cc07d91d95644aedd05d03f95e1dba8af0640028406250000000000030000000000000000000000000000000000000000000000000000000024856bc3000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002100400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003090b0e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000030d44e3ca00000000000000000000000000000000ffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000100000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf00000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000e5891850bb3f03090f03010000806f08004010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf0000000000000000000000000e5891850bb3f03090f03010000806f080040100000000000000000000000000000000000000000000000000000000000000000000000180000000000000000000000120000000000000014e0000000000001db0e592427a0aece92de3edee1f18e0157c058615640160008400a400000000000300000000000000000000000000000000000000000000000000000000f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000e5891850bb3f03090f03010000806f0800401000000000000000000000000000000000000000000000000000000000068c2f6c300000000000000000000000000000000000000000000000000000009aa04d157000000000000000000000000000000000000000000000000000000000243b1c40000000000000000000000000000000000000000000000000000000000000042a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f42260fac5e5542a773aa44fbcfedf7c193bc2c599000064cbb7c0000ab88b473b1f5afd9ef808440eed33bf000000000000000000000000000000000000000000000000000000000000";

        // Calculate the share value in collateral asset
        uint256 shareValueInCollateralAsset = shares
            * leverageManager.getLeverageTokenLendingAdapter(leverageToken).getEquityInCollateralAsset()
            / leverageManager.getFeeAdjustedTotalSupply(leverageToken);

        uint256 collateralUsedForDebtSwap = 0.4997737e8;
        uint256 expectedCollateralForSender = previewData.collateral - collateralUsedForDebtSwap;
        assertEq(expectedCollateralForSender, 0.49800663e8);

        uint256 diffSlippage = 1e18 - (expectedCollateralForSender * 1e18 / shareValueInCollateralAsset);
        assertLt(diffSlippage, 0.01e18);
        assertEq(diffSlippage, 0.001770991033376967e18); // ~0.18% slippage using Velora for the swap

        _redeemAndAssertBalances(
            shares,
            expectedCollateralForSender,
            IVeloraAdapter.Offsets(outputAmountOffset, maxInputAmountOffset, quotedInputAmountOffset),
            buyCalldata
        );
    }

    function _deposit() internal returns (uint256 shares) {
        uint256 collateralFromSender = 0.5e8; // Half of 1 cbBTC
        uint256 flashLoanAmount = 54600.165347e6;

        bytes memory sellCalldata =
            hex"e3ead59e00000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf0000000000000000000000000000000000000000000000000000000cb66c67e30000000000000000000000000000000000000000000000000000000002eff9ff0000000000000000000000000000000000000000000000000000000002f79281bce7a529eebe44659fdeb6647117805b0000000000000000000000000163639500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000196000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001960000000000000000000000000000008a000000000000001c0000000000000138800000000000000000000000000000000000000000000072006c4018f000a000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006c00000000000000000000000000000016000000000000001200000000000001130e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d600000000000000000000000000000000000000000000000000000002cbf921180000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f42260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000015e0a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af000000000000000000000000000000000000000000000000000000038f3d12d966a9893cc07d91d95644aedd05d03f95e1dba8af0000048002e40000ff0000030000000000000000000000000000000000000000000000000000000024856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000200000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f3d12d90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000c600b30fb0400701010f4b080409018b9006e000000000000000000000000000000000000000000000000000000000000000009995855c00494d039ab6792f18e368e530dff9310000014000840000ff00000300000000000000000000000000000000000000000000000000000000f196187f0000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bf000000000000000000000000000000000000000000029f16b11c6d1e00000032000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000017bc79e000000000000000000000000000000000000000000000000400065a8177fae27000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000104000000000000000a0000000000000138800000000000000000000000000000000000000000000056005040224000a000b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000001e000000000000000000000000000000320a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb000000000000000000000000eb1da432d5c1a9fdf52aa5d37698f34706f9139700000000000000000000000000000000000000000000000000000000822d4bd6eb1da432d5c1a9fdf52aa5d37698f34706f91397000001400024000020000003000000000000000000000000000000000000000000000000000000003eece7db00000000000000000000000000c600b30fb0400701010f4b080409018b9006e000000000000000000000000000000000000000000000000000000000822d4bd600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000160000000000000012000000000000012c0e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d6000000000000000000000000000000000000000000000000000000030d0fc7030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000bb8c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000016000000000000001200000000000001130e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d600000000000000000000000000000000000000000000000000000002cbf921190000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb480001f4c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000007c00764018f000a000b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000076000000000000000000000000000000160000000000000012000000000000015e0e592427a0aece92de3edee1f18e0157c0586156400000140008400000000000300000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d60000000000000000000000000000000000000000000000003127c207eaaf8db30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002bc02aaa39b223fe8d0a0e5c4f27ead9083c756cc20001f42260fac5e5542a773aa44fbcfedf7c193bc2c599000000000000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000000001130c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af000000000000000000000000000000000000000000000000269f3d0638655d0c66a9893cc07d91d95644aedd05d03f95e1dba8af0000052003640000ff0000030000000000000000000000000000000000000000000000000000000024856bc30000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000020c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000003060b0e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000269f3d0638655d0c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000002260fac5e5542a773aa44fbcfedf7c193bc2c59900000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2e592427a0aece92de3edee1f18e0157c0586156400000140008400ef0000000b00000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e00000000000000000000000000000000000000000000000000000000068c2f0d600000000000000000000000000000000000000000000000000000000017b74380000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b2260fac5e5542a773aa44fbcfedf7c193bc2c5990001f418084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000000000000000000000ae6ee608b297305abf3eb609b81febbb8f6a0bb3000000e0004400a4ff00000b000000000000000000000000000000000000000000000000000000003df021240000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000003764ec042a9b9f2000000000000000000000000000000000000000000000000000000000000000100000000000000000000000018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000cbb7c0000ab88b473b1f5afd9ef808440eed33bfcbb7c0000ab88b473b1f5afd9ef808440eed33bf0000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb0000000000000000000000006a000f20005980200259b80c510200304000106800000000000000000000000000000000000000000000000000000000017bcb92";

        address[] memory path = new address[](2);
        path[0] = address(USDC);
        path[1] = address(CBBTC);

        uint256 sharesBefore = leverageToken.balanceOf(user);

        ILeverageRouter.Call[] memory calls = new ILeverageRouter.Call[](2);
        // Approve Velora to spend the USDC for the swap
        calls[0] = ILeverageRouter.Call({
            target: address(USDC),
            data: abi.encodeWithSelector(IERC20.approve.selector, address(AUGUSTUS_V6_2), flashLoanAmount),
            value: 0
        });
        // Swap USDC to CBBTC
        calls[1] = ILeverageRouter.Call({target: AUGUSTUS_V6_2, data: sellCalldata, value: 0});

        _dealAndDeposit(CBBTC, USDC, collateralFromSender, collateralFromSender, flashLoanAmount, 0, calls);

        uint256 sharesAfter = leverageToken.balanceOf(user) - sharesBefore;

        return sharesAfter;
    }

    function _redeemAndAssertBalances(
        uint256 shares,
        uint256 minCollateralForSender,
        IVeloraAdapter.Offsets memory offsets,
        bytes memory swapData
    ) internal {
        uint256 collateralBeforeRedeem = morphoLendingAdapter.getCollateral();
        uint256 debtBeforeRedeem = morphoLendingAdapter.getDebt();
        uint256 userBalanceOfCollateralAssetBeforeRedeem = CBBTC.balanceOf(user);

        ActionData memory previewData = leverageManager.previewRedeem(leverageToken, shares);

        vm.startPrank(user);
        leverageToken.approve(address(leverageRouter), shares);
        leverageRouter.redeemWithVelora(
            leverageToken, shares, minCollateralForSender, veloraAdapter, AUGUSTUS_V6_2, offsets, swapData
        );
        vm.stopPrank();

        // Check that the periphery contracts don't hold any assets
        assertEq(CBBTC.balanceOf(address(veloraAdapter)), 0);
        assertEq(USDC.balanceOf(address(veloraAdapter)), 0);
        assertEq(CBBTC.balanceOf(address(leverageRouter)), 0);
        assertEq(USDC.balanceOf(address(leverageRouter)), 0);

        // Collateral and debt are removed from the leverage token
        assertEq(morphoLendingAdapter.getCollateral(), collateralBeforeRedeem - previewData.collateral);
        assertEq(morphoLendingAdapter.getDebt(), debtBeforeRedeem - previewData.debt);

        // The user receives back at least the min collateral and debt
        assertGe(CBBTC.balanceOf(user), userBalanceOfCollateralAssetBeforeRedeem + minCollateralForSender);
    }
}
